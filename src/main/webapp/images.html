<!DOCTYPE html>
<html>
<script type="text/javascript">

    const BUCKET = getUrlParamValue("bucket");
    const SCALE = getUrlParamValue("scale");
    const WIDTH = getUrlParamValue("width");
    const FORMAT = getUrlParamValue("format");

    if (!BUCKET) alert("No bucket provided");
   
    let headers = new Headers();
    headers.append("Accept", "application/json");

    let path = BUCKET;
    if(!path.endsWith("/")) path = path + "/";
    
    fetch(path + "?delimiter=/", {headers})
    .then(response => response.json())
    .then(value => {
    	
    	const CONTAINER = document.getElementById("container");
    	const HEADER = document.getElementById("header");
    	var imagesLoaded = 0;
    	var imagesFailed = 0;
 
        for(let dir of value) {    
           
        	dir = dir.subdir;
            if(dir) {
                let name = dir.substring(0, dir.lastIndexOf("."));
                let dzi = path + dir + name + ".dzi";
        		
                //SCALE rulz
                var url;
                if (WIDTH) url = window.location.origin + "/width/?dzi=" + dzi + "&width=" + WIDTH + "&format=" + FORMAT;
                if (SCALE) url = window.location.origin + "/scale/?dzi=" + dzi + "&scale=" + SCALE + "&format=" + FORMAT;
                
                var img = document.createElement('img');
                img.src = url;
                img.onload = function () {
                	console.log ("Loaded: " + dzi);
                	HEADER.innerHTML =  "Images (check console): " + value.length + ", loaded: " + ++imagesLoaded + ", failed: " + imagesFailed + "... ";
 					if ((imagesLoaded + imagesFailed) == value.length)
 						HEADER.innerHTML = HEADER.innerHTML + "Done!";	
                };
                img.onerror = function () {
                    console.log ("Failed: " + dzi);
                    HEADER.innerHTML =  "Images (check console): " + value.length + ", loaded: " + imagesLoaded + ", failed: " + ++imagesFailed  + "... ";
                    if ((imagesLoaded + imagesFailed) == value.length)
 						HEADER.innerHTML = HEADER.innerHTML + "Done!";
                };
                CONTAINER.appendChild(img);  
            }
        }
        //
        
    });
       
    function getUrlParamValue(paramName) {
        return (new URL(window.location)).searchParams.get(paramName);
    }

</script>
<body>

	<h4 id="header">Images (check console)</h4>

	<div id="container"></div>

</body>
</html>







